
# 1. **고정 윈도 카운터 (Fixed Window Counter)**

- **개념**: 고정된 시간 윈도우(예: 1초 또는 1분) 내에서 요청의 개수를 제한하는 방식
- **동작 원리**:
    - 각 시간 창마다 특정 요청 수를 허용하고, 요청 수가 초과하면 제한을 적용
    - 예를 들어, 1분에 최대 100개의 요청을 허용하는 경우 1분 창이 지나면 카운터가 초기화
- **장점**:
    - 구현이 간단하고 시간 창 내에서 효율적으로 동작.
    - 자원 소모가 적으며 제한 설정이 직관적.
- **단점**:
    - **Burst 문제**: 시간 창이 갱신되는 순간에 여러 요청이 한꺼번에 발생할 수 있어 처리량이 급격히 증가할 수 있다.
    - 특정 경우에 사용량이 일정하지 않으면 트래픽 제어가 비효율적일 수 있다.



## 예시

1분 동안 최대 5개의 요청만 허용하는 설정을 바탕으로 고정 윈도 카운터의 동작의 예시를 살펴보자.

- 제한 조건: 1분(60초) 창 동안 최대 5개의 요청을 허용
- 요청을 처리하는 서버에 적용되는 고정 윈도 카운터 방식의 처리율 제한
- 요청이 초과되면, 해당 요청에 대해 "429 Too Many Requests" 응답을 반환

### **1. 초기 상태 (시작 시간: 00:00)**

| 타임스탬프 | 요청 수 | 카운터 상태   | 설명                                 |
|------------|---------|---------------|--------------------------------------|
| 00:00      | 0       | 초기화 (0/5)  | 새로운 1분 창이 시작          |

> ```plaintext
> Time: 00:00 - Window [00:00 - 01:00]
> Allowed Requests: 5
> ```


### **2. 요청 발생 (00:10 - 00:35)**

| 타임스탬프 | 요청 수 | 카운터 상태   | 설명                                |
|------------|---------|---------------|-------------------------------------|
| 00:10      | +1      | 1/5           | 첫 번째 요청이 처리됨               |
| 00:15      | +1      | 2/5           | 두 번째 요청이 처리됨               |
| 00:20      | +1      | 3/5           | 세 번째 요청이 처리됨               |
| 00:30      | +1      | 4/5           | 네 번째 요청이 처리됨               |
| 00:35      | +1      | 5/5           | 다섯 번째 요청이 처리됨 (제한 도달) |


> ```plaintext
> Time: 00:10 - Window [00:00 - 01:00] - 1 Request (1/5)
> Time: 00:15 - Window [00:00 - 01:00] - 2 Requests (2/5)
> Time: 00:20 - Window [00:00 - 01:00] - 3 Requests (3/5)
> Time: 00:30 - Window [00:00 - 01:00] - 4 Requests (4/5)
> Time: 00:35 - Window [00:00 - 01:00] - 5 Requests (5/5)
> ```


### **3. 제한 초과 상태 (00:40 - 00:55)**

| 타임스탬프 | 요청 수 | 카운터 상태   | 설명                                |
|------------|---------|---------------|-------------------------------------|
| 00:40      | +1      | 5/5 (초과)    | 여섯 번째 요청 - 제한 초과, 거부됨  |
| 00:45      | +1      | 5/5 (초과)    | 일곱 번째 요청 - 제한 초과, 거부됨  |
| 00:55      | +1      | 5/5 (초과)    | 여덟 번째 요청 - 제한 초과, 거부됨  |

- **요청 제한 적용**: 요청 수가 5를 초과했기 때문에, 추가적인 요청은 모두 거부된다.
- **응답 코드**: 각 거부된 요청은 "429 Too Many Requests" 응답을 받는다.


> ```plaintext
> Time: 00:40 - Window [00:00 - 01:00] - Request Denied (5/5)
> Time: 00:45 - Window [00:00 - 01:00] - Request Denied (5/5)
> Time: 00:55 - Window [00:00 - 01:00] - Request Denied (5/5)
> ```



### **4. 윈도우 갱신 (01:00 - 01:30)**

| 타임스탬프 | 요청 수 | 카운터 상태   | 설명                                |
|------------|---------|---------------|-------------------------------------|
| 01:00      | 0       | 초기화 (0/5)  | 새로운 1분 창 시작, 카운터 리셋     |
| 01:05      | +1      | 1/5           | 첫 번째 요청이 다시 처리됨          |
| 01:10      | +1      | 2/5           | 두 번째 요청이 처리됨               |
| 01:20      | +1      | 3/5           | 세 번째 요청이 처리됨               |
| 01:30      | +1      | 4/5           | 네 번째 요청이 처리됨               |

- **윈도우 갱신**: 1분 창이 지나면 카운터가 초기화된다.
- 새로운 요청이 수락되며, 제한 조건 내에서 다시 요청을 처리한다.


> ```plaintext
> Time: 01:00 - Window [01:00 - 02:00] - Counter Reset (0/5)
> Time: 01:05 - Window [01:00 - 02:00] - 1 Request (1/5)
> Time: 01:10 - Window [01:00 - 02:00] - 2 Requests (2/5)
> Time: 01:20 - Window [01:00 - 02:00] - 3 Requests (3/5)
> Time: 01:30 - Window [01:00 - 02:00] - 4 Requests (4/5)
> ```


### **Burst 문제 시나리오**

- Burst 문제는 새로운 시간 창이 시작될 때 여러 요청이 동시에 몰리는 경우를 의미한다.
- 예를 들어, 01:00에 창이 갱신되자마자 5개의 요청이 한꺼번에 발생하는 경우, 첫 5개의 요청은 모두 처리되고, 그 후 들어오는 요청은 다시 제한이 걸리게 된다.


> ```plaintext
> Time: 01:00 - Window [01:00 - 02:00] - Burst of 5 Requests (5/5)
> Time: 01:01 - Window [01:00 - 02:00] - Request Denied (5/5)
> ```


### **정리**

고정 윈도 카운터는 구현이 간단하고 자원 효율성이 높은 방법이지만, **Burst 문제**로 인해 특정 시간에 급격한 요청이 몰릴 경우 비효율적일 수 있다.

이러한 문제를 해결하는 대안으로 이동 윈도 방식을 생각해볼 수 있다.





# 2. **이동 윈도 로그 (Sliding Window Log) 및 이동 윈도 카운터**

## 개념

이동 윈도 로그(Sliding Window Log)와 이동 윈도 카운터(Sliding Window Counter) 알고리즘은 요청을 제한하는 방식에서 시간 창을 고정하지 않고 유연하게 이동시키는 방식이다.

- **이동 윈도 로그**는 각 요청의 타임스탬프를 로그 형태로 기록하여, 현재 시점에서 일정 시간 내의 모든 요청을 추적하고 이를 기준으로 제한을 판단하는 방식
- **이동 윈도 카운터**는 시간 창을 작은 구간으로 나누어 각 구간의 요청 수를 기록한 후, 전체 구간의 요청 수를 합산하여 특정 시간 동안의 요청 개수를 추적하고 이를 기준으로 제한을 결정하는 방식

이 두 방식의 장점은 고정 윈도 카운터 방식의 **Burst 문제**를 해결한다는 점이다.
또한 트래픽을 좀 더 세밀하게 제어할 수 있다.


## 공통점 및 차이점

### 공통점
1. **이동 윈도 방식**: 두 알고리즘 모두 고정된 시간 창이 아닌, 현재 시점을 기준으로 이동하는 시간 창을 사용하여 요청을 제한한다.
2. **Burst 문제 완화**: 연속적인 시간 창 이동을 통해 고정 윈도 카운터의 한계인 Burst 문제를 해결하고, 보다 안정적인 트래픽 제어를 제공한다.
3. **정밀한 제어 가능**: 고정 윈도 방식보다 세밀하게 요청 제한을 적용할 수 있어 트래픽 부하가 분산되며, 갑작스러운 요청 폭주 상황을 보다 정교하게 관리할 수 있다.

### 차이점
1. **구현 방식**:
    - **이동 윈도 로그**는 모든 요청의 타임스탬프를 기록하며, 새 요청이 발생할 때마다 최근 일정 시간 내의 모든 타임스탬프를 확인하여 요청 수를 계산한다.
    - **이동 윈도 카운터**는 시간 창을 작은 구간으로 나누고, 각 구간의 요청 수를 저장하여 요청 개수를 계산하는 방식이다. 즉, 구간별 요청 수만을 추적하여 전체 요청 수를 산출한다.

2. **메모리 및 자원 사용량**:
    - **이동 윈도 로그**는 요청별 타임스탬프를 저장하므로, 요청 수가 많을 경우 메모리 사용량이 상당히 커질 수 있다.
    - **이동 윈도 카운터**는 구간별로 요청 개수만 기록하기 때문에 자원 소모가 적으며, 메모리 사용량이 비교적 낮다.

3. **정밀도**:
    - **이동 윈도 로그**는 개별 타임스탬프를 사용하여 요청을 계산하기 때문에, 시간 경과에 따른 요청 수를 정밀하게 계산할 수 있다.
    - **이동 윈도 카운터**는 구간 단위로 요청을 집계하기 때문에 이동 윈도 로그에 비해 다소 정밀도가 낮을 수 있지만, 효율성이 높다.

4. **성능**:
    - **이동 윈도 로그**는 타임스탬프 목록을 계속 관리해야 하므로, 초당 수천 개의 요청이 발생하는 환경에서는 성능이 저하될 수 있다.
    - **이동 윈도 카운터**는 구간별 집계 방식을 통해 연산을 줄이므로, 로그 방식보다 성능이 우수하다.


## 이동 윈도 로그 (Sliding Window Log) 작동 원리 및 예시

이동 윈도 로그 방식에서는 요청이 발생할 때마다 해당 요청의 타임스탬프가 기록된다.
새로운 요청이 들어올 때 시스템은 지난 일정 시간 내에 발생한 모든 요청의 타임스탬프를 확인하고, 이를 기준으로 요청 수를 계산하여 제한을 적용한다.

다음과 같은 설정에서 이동 윈도 로그 방식이 작동하는 원리를 예시로 살펴보자.

- **제한 조건**: 최근 1분 동안 최대 5개의 요청만 허용
- **처리 방식**: 이동 윈도 로그 방식으로 각 요청의 타임스탬프를 저장
- **초과 시 응답 코드**: 429 Too Many Requests

### **1. 초기 상태**

| 타임스탬프 | 요청 수 | 타임스탬프 로그           | 설명                                   |
|------------|---------|---------------------------|----------------------------------------|
| 00:00      | 0       | 초기화 (비어 있음)        | 시스템 시작 시 타임스탬프 로그는 비어 있음 |


### **2. 요청 발생 (00:05 - 00:45)**

| 타임스탬프 | 요청 수 | 타임스탬프 로그           | 설명                                    |
|------------|---------|---------------------------|-----------------------------------------|
| 00:05      | +1      | [00:05]                   | 첫 번째 요청이 발생하여 기록됨           |
| 00:15      | +1      | [00:05, 00:15]            | 두 번째 요청 발생, 로그에 타임스탬프 추가|
| 00:20      | +1      | [00:05, 00:15, 00:20]     | 세 번째 요청 발생                       |
| 00:30      | +1      | [00:05, 00:15, 00:20, 00:30] | 네 번째 요청 발생                    |
| 00:45      | +1      | [00:05, 00:15, 00:20, 00:30, 00:45] | 다섯 번째 요청 발생, 제한 도달 |

- **상태**: 타임스탬프 로그에 5개의 요청이 기록됨.
- **제한 도달**: 이동 윈도 로그 방식에서 1분 내 5개 요청이 허용되는 최대값에 도달한 상태이다.

> ```plaintext
> Time: 00:45 - Allowed Requests: 5 - Requests: [00:05, 00:15, 00:20, 00:30, 00:45]
> ```


### **3. 제한 초과 상태 (00:50)**

| 타임스탬프 | 요청 수 | 타임스탬프 로그                         | 설명                                     |
|------------|---------|-----------------------------------------|------------------------------------------|
| 00:50      | +1      | [00:05, 00:15, 00:20, 00:30, 00:45]    | 요청 거부 - 타임스탬프 로그 내 요청 수 5개 |

- **제한 초과**: 1분 내 5개 요청 제한이 초과되었으므로, 00:50에 발생한 요청은 거부된다.
- **응답 코드**: "429 Too Many Requests" 응답을 반환.

> Time: 00:50 - Request Denied (Limit Exceeded) - Requests: [00:05, 00:15, 00:20, 00:30, 00:45]
> ```

---

### **4. 타임스탬프 로그 갱신 (01:05)**

| 타임스탬프 | 요청 수 | 타임스탬프 로그                | 설명                                         |
|------------|---------|--------------------------------|----------------------------------------------|
| 01:05      | +1      | [00:15, 00:20, 00:30, 00:45, 01:05] | 새로운 요청 - 제한 내 허용, 00:05 요청 제거 |

- **로그 갱신**: 1분 창이 이동하며 00:05 요청이 타임스탬프 로그에서 제거된다.
- **제한 상태 해제**: 1분 내 요청 수가 5개로 다시 허용된 상태가 된다.
- **응답 코드**: 요청은 정상적으로 처리된다.

> ```plaintext
> Time: 01:05 - Allowed Requests: 5 - Requests: [00:15, 00:20, 00:30, 00:45, 01:05]
> ```



## 이동 윈도 카운터 (Sliding Window Counter) 작동 원리 및 예시

이동 윈도 카운터 방식은 시간 창을 작은 간격으로 나누고, 각 구간마다 요청 수를 기록하여 전체 요청 개수를 계산한다.
새로운 요청이 발생할 때마다 현재 구간의 요청 수를 더하고, 오래된 구간의 요청 수를 빼는 방식으로 전체 요청 수를 산출하여 제한을 적용한다.

다음과 같은 설정에서 이동 윈도 로그 방식이 작동하는 원리를 예시로 살펴보자.

- **제한 조건**: 최근 1분 동안 최대 5개의 요청만 허용
- **구간 분할**: 1분 창을 10초 단위로 나눠 각 구간별 요청 수를 저장
- **초과 시 응답 코드**: 429 Too Many Requests


### **1. 초기 상태 (시작 시간: 00:00)**

| 타임스탬프 | 요청 수 | 구간별 요청 수 기록           | 설명                                       |
|------------|---------|-------------------------------|--------------------------------------------|
| 00:00      | 0       | 모든 구간 초기화 (0/5)        | 시스템 시작 시 모든 구간 요청 수는 0으로 초기화 |

> ```plaintext
> Time: 00:00 - Window Segments: [00:00 - 00:10]: 0, [00:10 - 00:20]: 0, ..., [00:50 - 01:00]: 0
> ```

---

### **2. 요청 발생 (00:05 - 00:35)**

| 타임스탬프 | 요청 수 | 구간별 요청 수 기록                           | 설명                                  |
|------------|---------|-----------------------------------------------|---------------------------------------|
| 00:05      | +1      | [00:00 - 00:10]: 1                           | 첫 번째 요청 발생, 첫 번째 구간에 기록 |
| 00:15      | +1      | [00:00 - 00:10]: 1, [00:10 - 00:20]: 1       | 두 번째 요청 발생, 두 번째 구간에 기록 |
| 00:20      | +1      | [00:00 - 00:10]: 1, [00:10 - 00:20]: 2       | 세 번째 요청 발생, 두 번째 구간에 기록 |
| 00:30      | +1      | [00:00 - 00:10]: 1, [00:10 - 00:20]: 2, [00:20 - 00:30]: 1 | 네 번째 요청 발생, 세 번째 구간에 기록 |
| 00:35      | +1      | [00:00 - 00:10]: 1, [00:10 - 00:20]: 2, [00:20 - 00:30]: 1, [00:30 - 00:40]: 1 | 다섯 번째 요청 발생, 네 번째 구간에 기록 |

- **상태**: 현재 1분 내 총 요청 수는 5이며, 각 구간별로 요청이 분산되어 있음.
- **제한 도달**: 이동 윈도 카운터 방식에서 1분 내 5개 요청 허용 한도에 도달한 상태.

> ```plaintext
> Time: 00:35 - Total Requests: 5 (Limit Reached) - Window Segments: [00:00 - 00:10]: 1, [00:10 - 00:20]: 2, [00:20 - 00:30]: 1, [00:30 - 00:40]: 1
> ```


### **3. 제한 초과 상태 (00:40)**

| 타임스탬프 | 요청 수 | 구간별 요청 수 기록                                   | 설명                                     |
|------------|---------|-------------------------------------------------------|------------------------------------------|
| 00:40      | +1      | [00:00 - 00:10]: 1, [00:10 - 00:20]: 2, [00:20 - 00:30]: 1, [00:30 - 00:40]: 1, [00:40 - 00:50]: 1 | 요청 거부 - 1분 내 요청 수 5개 초과 |

- **제한 초과**: 1분 내 5개 요청 제한을 초과했으므로, 00:40에 발생한 요청은 거부된다.
- **응답 코드**: "429 Too Many Requests" 응답을 반환한다.

> Time: 00:40 - Request Denied (Limit Exceeded) - Window Segments: [00:00 - 00:10]: 1, [00:10 - 00:20]: 2, [00:20 - 00:30]: 1, [00:30 - 00:40]: 1, [00:40 - 00:50]: 1
> ```

---

### **4. 구간 갱신 (00:55 - 01:05)**

| 타임스탬프 | 요청 수 | 구간별 요청 수 기록                                         | 설명                                   |
|------------|---------|-------------------------------------------------------------|----------------------------------------|
| 01:05      | +1      | [00:10 - 00:20]: 2, [00:20 - 00:30]: 1, [00:30 - 00:40]: 1, [00:40 - 00:50]: 1, [01:00 - 01:10]: 1 | 구간 갱신 후 요청 수가 5로 허용됨      |

- **구간 갱신**: 이동 윈도가 1분 동안 이동하며 00:00 - 00:10 구간이 만료되고 제거된다.
- **제한 상태 해제**: 구간별 총 요청 수가 다시 허용 가능한 최대 요청 수인 5로 맞춰짐.
- **응답 코드**: 요청은 정상적으로 처리된다.

> ```plaintext
> Time: 01:05 - Allowed Requests: 5 - Window Segments: [00:10 - 00:20]: 2, [00:20 - 00:30]: 1, [00:30 - 00:40]: 1, [00:40 - 00:50]: 1, [01:00 - 01:10]: 1
> ```


